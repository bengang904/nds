<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>NDS Player</title>
  <style>
    html,
    body {
      margin: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
    }

    #stage {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #player {
      width: 256px;
      height: 384px;
      display: flex;
      flex-direction: column;
      transform-origin: center center;
    }

    #player canvas {
      display: block;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <div id="stage">
    <desmond-player id="player">
      <canvas id="top" width="256" height="192"></canvas>
      <canvas id="bottom" width="256" height="192"></canvas>
    </desmond-player>
  </div>

  <script src="/desmond.min.js"></script>
  <script>
  const ndsPlayer = document.getElementById("player");
  const bottom = document.getElementById("bottom");

  function resizeNDS() {
    const scale = Math.min(
      window.innerWidth / 256,
      window.innerHeight / 384
    );
    ndsPlayer.style.transform = `scale(${scale})`;
    ndsPlayer.dataset.scale = scale;
  }

  window.addEventListener("resize", resizeNDS);
  resizeNDS();

  const nds = new URLSearchParams(location.search).get("nds");
  if (nds) {
    ndsPlayer.loadURL(nds);
  }

  /* ====== 核心：彻底屏蔽 Desmond 的 touch ====== */
  ["touchstart", "touchmove", "touchend"].forEach(type => {
    document.addEventListener(type, e => {
      e.preventDefault();
      e.stopImmediatePropagation();
    }, { capture: true, passive: false });
  });

  /* ====== 鼠标 → 触屏映射（下屏） ====== */
  function getTouchPos(e) {
    const rect = bottom.getBoundingClientRect();
    const scale = Number(ndsPlayer.dataset.scale) || 1;

    const x = (e.clientX - rect.left) / scale;
    const y = (e.clientY - rect.top) / scale;

    return {
      x: Math.max(0, Math.min(255, x)),
      y: Math.max(0, Math.min(191, y))
    };
  }

  let touching = false;

  bottom.addEventListener("mousedown", e => {
    touching = true;
    const { x, y } = getTouchPos(e);
    ndsPlayer.touchDown(x, y);
  });

  window.addEventListener("mousemove", e => {
    if (!touching) return;
    const { x, y } = getTouchPos(e);
    ndsPlayer.touchMove(x, y);
  });

  window.addEventListener("mouseup", () => {
    if (!touching) return;
    touching = false;
    ndsPlayer.touchUp();
  });
</script>

</body>
</html>
